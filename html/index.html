<!DOCTYPE HTML>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
	<link rel="shortcut icon" href="about:blank">
    <link rel="stylesheet" href="css/chota.css">
    <script src='js/bignumber.min.js'></script>
  </head>
<body>
 <div class="container">
     <div class="row">
         <div class="col">
             <h2 class="is-text-center is-marginless">Generic Monero Scanner</h2>
             <h5 class="is-text-center is-marginless">Fully <a href="https://github.com/moneroexamples/generic-xmr-scanner">open sourced</a> scanner of monero blockchain</h5>
         </div>
     </div>

	<div>
		<p class="is-horizontal-align">
        <span class="text-error">No SSL/HTTPs avaiable</span>. Please use only publicly available addresses over insecure network.
		</p>
	</div>

     <form>
       <fieldset id="forms_input">
            <legend>Scan for outputs with address and its viewkey</legend>
         <p>
		    <label for="known-address">Public addresses</label>
			<select id="known-address">
              <optgroup label="Use one of the publicly avaliable addresses">
                  <!-- placeholder for addresses -->
              </optgroup>
		    </select>
         </p>
         <p>
			<label for="address">Address</label>
            <input id="address" type="text" value="56heRv2ANffW1Py2kBkJDy8xnWqZsSrgjLygwjua2xc8Wbksead1NK1ehaYpjQhymGK4S8NPL9eLuJ16CuEJDag8Hq3RbPV"/>
         </p>
         <p>
			<label for="viewkey">Viewkey</label>
            <input id="viewkey" type="text" value="b45e6f38b2cd1c667459527decb438cdeadf9c64d93c8bccf40a9bf98943dc09"/>
         <p>
		<p>
	   <label for="timespan">Start scannig from</label>
		<select id="timespan">
		  <optgroup label="Since when?">
			<option selected="selected" value="1">One day ago</option>
			<option value="2">One week ago</option>
			<option value="3">One month ago</option>
		  </optgroup>
		</select>
        </p>
        <p>
        <label for="skip-coinbase"></label>
        <input id="skip-coinbase" name="checkbox" type="checkbox" checked="checked">Skip coinbase transactions (faster scanning)
        <button class="pull-right" id="submit-btn" type="button">Search</button>
		</p>
       </fieldset>
     </form>

    <div class="row">
      <ul id="messages"></ul>
  </div>

  <table id="outputs-table">
    <caption>Output scanning results. Progress: <span id="status-info">n/a</span></caption>
    <thead>
      <tr>
        <th>Block Height</th>
        <th>Timestamp</th>
        <th>Transaction id</th>
        <th>Amount</th>
        <th>Subaddr idx</th>
      </tr>
    </thead>
    <tbody id="outputs-table-body">
    </tbody>
  </table>

 </div>

<script type="text/javascript">
// index.html is based on the code provided by Restbed
// https://github.com/Corvusoft/restbed/blob/master/documentation/example/WEB_SOCKET.md#client

function add_message( message )
{
     var li = document.createElement( "li" );
     li.innerHTML = message;

     var ul = document.getElementById( "messages" );
     ul.appendChild( li );
}


function ajax_get(url, callback)
{
    var xhr = new XMLHttpRequest({mozSystem: true});
    xhr.open('GET', url );
    xhr.onload = function() {
        if (xhr.status === 200) {
            callback(xhr.responseText);
        }
        else {
            alert('ajax_get failed: ' + xhr.status);
        }
    };
    xhr.send();
}

function setup_network()
{
    ajax_get(window.xmrscanner_url_http + "/status", 
            function(response_txt) {
                //console.log(response_txt);
                var jstatus = JSON.parse(response_txt);

                if (jstatus['status'] == 'success')
                {
                    setup_known_addresses(jstatus['data']['network'])
                }
            });
}

function setup_known_addresses(nettype)
{
    if (nettype === 0)
    {
        avaliable_addresses = [
        {
            name: "Monero project donation address",
            address: "44AFFq5kSiGBoZ4NMDwYtN18obc8AemS33DBLWs3H7otXft3XjrpDtQGv7SqSsaBYBb98uNbr2VBBEt7f2wfn3RVGQBEP3A", 
            viewkey: "f359631075708155cc3d92a32b75a7d02a5dcf27756707b47a2b31b21c389501"
        },
        {
            name: "Monero forum donation address",
            address: "45ttEikQEZWN1m7VxaVN9rjQkpSdmpGZ82GwUps66neQ1PqbQMno4wMY8F5jiDt2GoHzCtMwa7PDPJUJYb1GYrMP4CwAwNp", 
            viewkey: "c9347bc1e101eab46d3a6532c5b6066e925f499b47d285d5720e6a6f4cc4350c"
        },
        {
            name: "Monerujo donation address",
            address: "4AdkPJoxn7JCvAby9szgnt93MSEwdnxdhaASxbTBm6x5dCwmsDep2UYN4FhStDn5i11nsJbpU7oj59ahg8gXb1Mg3viqCuk", 
            viewkey: "b1aff2a12191723da0afbe75516f94dd8b068215f6e847d8da57aca5f1f98e0c"
        }
        ];
    }
    else if (nettype === 1)
    {
        avaliable_addresses = [
        {
            name: "Testnet wallet 1",
            address: "A2VTvE8bC9APsWFn3mQzgW8Xfcy2SP2CRUArD6ZtthNaWDuuvyhtBcZ8WDuYMRt1HhcnNQvpXVUavEiZ9waTbyBhP6RM8TV", 
            viewkey: "041a241325326f9d86519b714a9b7f78b29111551757eeb6334d39c21f8b7400"
        },
        {
            name: "Testnet wallet 2",
            address: "9wUf8UcPUtb2huK7RphBw5PFCyKosKxqtGxbcKBDnzTCPrdNfJjLjtuht87zhTgsffCB21qmjxjj18Pw7cBnRctcKHrUB7N", 
            viewkey: "3561b7f41a5a22c85ad8fd3016255cd7ce4bf3ec063dbf41e6e5a10ba0e5db07"
        },
        {
            name: "Testnet wallet 3",
            address: "9viPdjLNXDaRFNtTTDg5wXg9Yg55uDC9XRLv882aPAFye1Ta6fSh25M41JoXBQj8d964JyFXuLVddEdg71cPJ8DY7WrSH3z", 
            viewkey: "ab227fb819e2b2100bb00840df1f00ed89867752d7d9d7918f6db6a0fa7f6b0c"
        }
        ];
    }
    else if (nettype === 2)
    {
        avaliable_addresses = [
        {
            name: "Stagenet wallet 1",
            address: "56heRv2ANffW1Py2kBkJDy8xnWqZsSrgjLygwjua2xc8Wbksead1NK1ehaYpjQhymGK4S8NPL9eLuJ16CuEJDag8Hq3RbPV", 
            viewkey: "b45e6f38b2cd1c667459527decb438cdeadf9c64d93c8bccf40a9bf98943dc09"
        },
        {
            name: "Stagenet wallet 2",
            address: "55ZbQdMnZHPFS8pmrhHN5jMpgJwnnTXpTDmmM5wkrBBx4xD6aEnpZq7dPkeDeWs67TV9HunDQtT3qF2UGYWzGGxq3zYWCBE", 
            viewkey: "c8a4d62e3c86de907bd84463f194505ab07fc231b3da753342d93fccb5d39203"
        },
        {
            name: "Stagenet wallet 3",
            address: "57Hx8QpLUSMjhgoCNkvJ2Ch91mVyxcffESCprnRPrtbphMCv8iGUEfCUJxrpUWUeWrS9vPWnFrnMmTwnFpSKJrSKNuaXc5q", 
            viewkey: "9595c2445cdd4c88d78f0af41ebdf52f68ae2e3597b9e7b99bc3d62e300df806"
        },
        {
            name: "Stagenet wallet 4",
            address: "5BAP9qLbRseYrGneYVRaFANMajuaD4KZrf3fGWvt5cVDR1xUXm6qoFYLkgU6Vp12fs2R24r4269inAWHFEdsLnE87rGCxYK", 
            viewkey: "585db489cbb1eb4ec3b6b4dfe953a676bbc3af21bd3ac0765d039cdd0d497700"
        },
        ];
    }

    var known_address = document.getElementById("known-address");

    // populate know-addresses select

    for (var i = 0; i < avaliable_addresses.length; i++)
    {
        var opt = document.createElement('option');

        opt.value = i+1;
        opt.innerHTML = avaliable_addresses[i].name;

        if (i === 0)
            opt.selected = true;

        known_address.childNodes[1].appendChild(opt);
    }

    var address = document.getElementById("address");
    var viewkey = document.getElementById("viewkey");
            
    var selected_value = known_address.value - 1;

    address.value = avaliable_addresses[selected_value].address;   
    viewkey.value = avaliable_addresses[selected_value].viewkey;   
        
    known_address.addEventListener("change",
        function(evt) 
        {
            var selected_value = known_address.value - 1;

            address.value = avaliable_addresses[selected_value].address;   
            viewkey.value = avaliable_addresses[selected_value].viewkey;   
        });
}

function setup_submit_btn()
{
    var submit_button = document.getElementById("submit-btn");
        
    submit_button.addEventListener("click",
    function(evt) 
    {
        if ( window.restbed.ws !== null 
                && window.restbed.ws.readyState === window.restbed.ws.OPEN) 
        {
            window.restbed.ws.close();
        }

        open();
    });
}

function remove_children(elem_name)
{
	var elem = document.getElementById(elem_name);

	while (elem.firstChild) {
		elem.removeChild(elem.firstChild);
	}
}

function open()
{
 if ("WebSocket" in window)
 {
    var ws = new WebSocket(window.xmrscanner_url_ws + '/search');

    ws.onopen = function()
    {
		remove_children('messages');
		remove_children('outputs-table-body');

        add_message("Established connection.");

        var address = document.getElementById("address").value;
        var viewkey = document.getElementById("viewkey").value;
        var timespan = document.getElementById("timespan").value;
        var skip_coinbase = document.getElementById("skip-coinbase").checked;

        var message = {"scanner": "outputs",
                       "address": address, 
                       "viewkey": viewkey,
                       "timespan": timespan,
                       "coinbase": skip_coinbase};

        add_message("submitting address and viewkey to the server");

        ws.send(JSON.stringify(message));
    };

    ws.onmessage = function(evt)
    {
       var results = "";

        try 
        {
            results = JSON.parse(evt.data); 
        } 
        catch(e)
        {
            console.log("cant parson json: ", evt.data);
            return;
        }

       if ('status' in results)
       {
            if (results.status === 'error')
            {
                add_message('<span style="color:red">' 
                            + results.message + '</span>');
                return;
            }
       }

       var status_info = document.getElementById("status-info");

        results["msgs"].forEach(function(msg)
        {
           if (msg["status"] !== "success")
               return;

           var data = msg["data"];

           if ("progress" in data)
           {
                var current_block = data["progress"]["current_block"];
                var blockchain_height 
                   = data["progress"]["blockchain_height"];

                status_info.innerHTML = current_block 
                                + "/" + blockchain_height;
                return;
           }

           if ("outputs" in data)
           {
               var outputs_table = document.getElementById("outputs-table-body");

               var blk_number    = data["block"];
               var blk_timestamp = new Date(data["timestamp"]*1000)
                                            .toUTCString();
               var tx            = data["tx"]; 

               for (var i = 0; i < data["outputs"].length; i++)
               {
                   var output = data["outputs"][i];

                   var amount = BigNumber(output["amount"]);
                   var to_show = output.public_key 
                        + ", " + amount.toString();
                   //add_message(to_show);

                   var subaddress_index = output.subaddr_idx;

                   var new_row = outputs_table.insertRow(-1);

                   var blk = new_row.insertCell(0);
                   var timestamp = new_row.insertCell(1);
                   //var public_key= new_row.insertCell(2);
                   var tx_hash = new_row.insertCell(2);
                   var amountt = new_row.insertCell(3);
                   var subaddr_idx = new_row.insertCell(4);
                   
                   blk.innerHTML        = blk_number;
                   timestamp.innerHTML  = blk_timestamp;
                   //public_key.innerHTML = output.public_key;
                   tx_hash.innerHTML = tx;
                   subaddr_idx.innerHTML = subaddress_index;
                   amountt.innerHTML = amount.dividedBy(1e12).toString();
               }

               return;
           }
        });

       // console.log(results);
    };

    ws.onclose = function(evt)
    {
       add_message("Connection closed with RFC6455 code " + evt.code + ".");
    };

    ws.onerror = function( evt )
    {
       add_message("Error: socket connection interrupted.");
    };

    window.restbed.ws = ws;
 }
 else
 {
    alert("WebSockets NOT supported by your Browser!");
 }
}

(function()
{
    window.xmrscanner_url_http = "http://127.0.0.1:8848"
    window.xmrscanner_url_ws = "ws://127.0.0.1:8848"
    window.restbed = { ws: null };
    setup_network();
    setup_submit_btn();
})();
</script>
</body>
</html>
