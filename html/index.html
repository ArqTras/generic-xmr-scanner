<!DOCTYPE HTML>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <link rel="stylesheet" href="css/chota.css">
    <script src='js/bignumber.min.js'></script>
  </head>
<body>
 <div class="container">
     <div class="row">
         <div class="col">
             <h2 class="is-text-center is-marginless">Generic Monero Scanner</h2>
             <h5 class="is-text-center is-marginless">Fully <a href="https://github.com/moneroexamples/generic-xmr-scanner">open sourced</a> scanner of monero blockchain</h5>
         </div>
     </div>
     <form>
       <fieldset id="forms_input">
            <legend>Scan for outputs with address and its viewkey</legend>
         <p>
		    <label for="known-address">Public addresses</label>
			<select id="known-address">
              <optgroup label="Use one of the publicly avaliable addresses">
                <option selected="selected" value="1">Monero project donation</option>
                <option value="2">Monero community crowdfunding system forum</option>
                <option value="3">Monerujo donation</option>
              </optgroup>
		    </select>
         </p>
         <p>
			<label for="address">Address</label>
            <input id="address" type="text" value="56heRv2ANffW1Py2kBkJDy8xnWqZsSrgjLygwjua2xc8Wbksead1NK1ehaYpjQhymGK4S8NPL9eLuJ16CuEJDag8Hq3RbPV"/>
         </p>
         <p>
			<label for="viewkey">Viewkey</label>
            <input id="viewkey" type="text" value="b45e6f38b2cd1c667459527decb438cdeadf9c64d93c8bccf40a9bf98943dc09"/>
         <p>
		<p>
	   <label for="timespan">Start scannig from</label>
		<select id="timespan">
		  <optgroup label="Since when?">
			<option selected="selected" value="1">One day ago</option>
			<option value="2">One week ago</option>
			<option value="3">Two weeks ago</option>
			<option value="4">One month ago</option>
		  </optgroup>
		</select>
        </p>
        <p>
        <label for="skip-coinbase"></label>
        <input id="skip-coinbase" name="checkbox" type="checkbox" checked="checked">Skip coinbase transactions (faster scanning)
        <button class="pull-right" id="submit-btn" type="button">Search</button>
		</p>
       </fieldset>
     </form>

  <div id="status-info" class="row"></div>
  <div class="row">
      <ul id="messages"></ul>
  </div>

  <table id="outputs-table">
    <caption>Output scanning results</caption>
    <thead>
      <tr>
        <th>Block Height</th>
        <th>Timestamp</th>
        <th>Output Public Key</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

 </div>

<script type="text/javascript">
  // index.html is based on the code provided by Restbed
  // https://github.com/Corvusoft/restbed/blob/master/documentation/example/WEB_SOCKET.md#client

  function add_message( message )
  {
     var li = document.createElement( "li" );
     li.appendChild( document.createTextNode( "> " + message ) );

     var ul = document.getElementById( "messages" );
     ul.appendChild( li );
  }


 function setup_submit_btn()
 {
    var submit_button = document.getElementById("submit-btn");
        
    submit_button.addEventListener("click",
        function(evt) 
        {
            if ( window.restbed.ws !== null 
                    && window.restbed.ws.readyState === window.restbed.ws.OPEN) 
            {
                window.restbed.ws.close();
            }

            open();
        });
 }
 
function setup_known_addresses()
 {

    avaliable_addresses = [
        {
            name: "Monero project donation address",
            address: "44AFFq5kSiGBoZ4NMDwYtN18obc8AemS33DBLWs3H7otXft3XjrpDtQGv7SqSsaBYBb98uNbr2VBBEt7f2wfn3RVGQBEP3A", 
            viewkey: "f359631075708155cc3d92a32b75a7d02a5dcf27756707b47a2b31b21c389501"
        },
        {
            name: "Monero forum donation address",
            address: "45ttEikQEZWN1m7VxaVN9rjQkpSdmpGZ82GwUps66neQ1PqbQMno4wMY8F5jiDt2GoHzCtMwa7PDPJUJYb1GYrMP4CwAwNp", 
            viewkey: "c9347bc1e101eab46d3a6532c5b6066e925f499b47d285d5720e6a6f4cc4350c"
        },
        {
            name: "Monerujo donation address",
            address: "4AdkPJoxn7JCvAby9szgnt93MSEwdnxdhaASxbTBm6x5dCwmsDep2UYN4FhStDn5i11nsJbpU7oj59ahg8gXb1Mg3viqCuk", 
            viewkey: "b1aff2a12191723da0afbe75516f94dd8b068215f6e847d8da57aca5f1f98e0c"
        }
    ];


    var known_address = document.getElementById("known-address");

    var address = document.getElementById("address");
    var viewkey = document.getElementById("viewkey");
            
    var selected_value = known_address.value - 1;

    address.value = avaliable_addresses[selected_value].address;   
    viewkey.value = avaliable_addresses[selected_value].viewkey;   
        
    known_address.addEventListener("change",
        function(evt) 
        {
            var selected_value = known_address.value - 1;

            address.value = avaliable_addresses[selected_value].address;   
            viewkey.value = avaliable_addresses[selected_value].viewkey;   

        });
 }

  function open()
  {
     if ("WebSocket" in window)
     {
        var ws = new WebSocket("ws://127.0.0.1:8848/search");

        ws.onopen = function()
        {
           add_message("Established connection.");

            var address = document.getElementById("address").value;
            var viewkey = document.getElementById("viewkey").value;
            var timespan = document.getElementById("timespan").value;
            var skip_coinbase = document.getElementById("skip-coinbase").checked;

            var message = {"scanner": "outputs",
                           "address": address, 
                           "viewkey": viewkey,
                           "timespan": timespan,
                           "coinbase": skip_coinbase};

            add_message("submitting address and viewkey to the server");
    
            ws.send(JSON.stringify(message));
        };

        ws.onmessage = function(evt)
        {
           var results = "";

            try 
            {
                results = JSON.parse(evt.data); 
            } 
            catch(e)
            {
                console.log("cant parson json: ", evt.data);
                return;
            }

           var status_info = document.getElementById("status-info");

            results["msgs"].forEach(function(msg)
            {
               if (msg["status"] !== "success")
                   return;

               var data = msg["data"];

               if ("progress" in data)
               {
                    var current_block = data["progress"]["current_block"];
                    var blockchain_height 
                       = data["progress"]["blockchain_height"];

                    status_info.innerHTML = current_block 
                                    + "/" + blockchain_height;
                    return;
               }

               if ("outputs" in data)
               {
                   var outputs_table = document.getElementById("outputs-table");

                   var blk_number    = data["block"];
                   var blk_timestamp = new Date(data["timestamp"]*1000)
                                                .toUTCString();

                   for (var i = 0; i < data["outputs"].length; i++)
                   {
                       var output = data["outputs"][i];

                       var amount = BigNumber(output["amount"]);
                       var to_show = output.public_key 
                            + ", " + amount.toString();
                       //add_message(to_show);

                       var new_row = outputs_table.insertRow(-1);

                       var blk = new_row.insertCell(0);
                       var timestamp = new_row.insertCell(1);
                       var public_key= new_row.insertCell(2);
                       var amountt = new_row.insertCell(3);
                       
                       blk.innerHTML        = blk_number;
                       timestamp.innerHTML  = blk_timestamp;
                       public_key.innerHTML = output.public_key;
                       amountt.innerHTML = amount.dividedBy(1e12).toString();
                   }

                   return;
               }
            });

           // console.log(results);
        };

        ws.onclose = function(evt)
        {
           add_message("Connection closed with RFC6455 code " + evt.code + ".");
        };

        ws.onerror = function( evt )
        {
           add_message("Error: socket connection interrupted.");
        };

        window.restbed.ws = ws;
     }
     else
     {
        alert("WebSockets NOT supported by your Browser!");
     }
  }

  (function()
  {
    window.restbed = { ws: null };
    setup_submit_btn();
    setup_known_addresses()
  })();
</script>
</body>
</html>
